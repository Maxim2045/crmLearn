<html>
    <head>
        <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>-->
        <script src="nav_jquery.min"></script>
        <script src = "nav_jquery.dataTables"></script>
       <!-- <script src = "https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script>-->
        <link rel="stylesheet" href="nav_jquery.dataTablesCss">
       <!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">-->
        <script src = "ClientGlobalContext.js.aspx" type = "text/javascript"></script>

        <!--<script src="jquery.min.js"></script>-->
        <script>

        const creditColumnId = 0;
        const modelColumnId = 1;

           $(document).ready(function () {
               "use strict";
               var oParameters = GetGlobalContext().getQueryStringParameters();
               var sParentCustId = oParameters.id;
               fnOnPageLoad(sParentCustId);
           });

           function fnOnPageLoad(sParentCustId){
               "use strict";

            var contFetchXML =        "<fetch distinct='true'>" +
                                        "<entity name='nav_agreement'>" +
                                            "<link-entity name='nav_auto' from='nav_autoid' to='nav_autoid' alias='na'>" +
                                                "<attribute name='nav_modelid' />" +
                                                "<filter>" +
                                                    "<condition attribute='nav_brandid' operator='eq' value='" + sParentCustId + "' />" +
                                                "</filter>" +
                                                "<link-entity name='nav_model' from='nav_modelid' to='nav_modelid'>" +
                                                    "<attribute name='nav_modelid' alias='nav_modelid_key'/>" +
                                                    "<attribute name='nav_name' alias='nav_modelname'/>" +
                                                "</link-entity>" +
                                            "</link-entity>" +
                                            "<link-entity name='nav_credit' from='nav_creditid' to='nav_creditid'>" +
                                                "<attribute name='nav_creditid' alias='nav_creditid_key'/>" +
                                                "<attribute name='nav_creditperiod' alias='nav_creditperiod'/>" +
                                                "<attribute name='nav_name' alias='nav_creditname' />" +
                                            "</link-entity>" +
                                        "</entity>" +
                                    "</fetch>";
           

            let path = "?fetchXml=" + contFetchXML;

           Xrm.WebApi.retrieveMultipleRecords("nav_agreement", path).then(
               function success(result){
                   "use strict";
                   var oResult = result.entities;
                   if(oResult != null)
                   {
                        successGetData(oResult);
                   }
               },
               function(oError)
               {
                   Xrm.Utility.alertDialog(oError.message, null);
               }
           )
        };
 

        function successGetData (oResult) {
            $("#CreditInfoTable").DataTable({
                           "data": oResult,
                           "columns":[
                              {'data': 'nav_creditname'},
                              {'data': 'nav_modelname'},
                              {'data': 'nav_creditperiod'}
                           ]
                       });
                       $("#CreditInfoTable").on('click','td',function () {
                        var table = $('#CreditInfoTable').DataTable();
                        let selectColumnIndex = table.cell(this)[0][0].column;
                        let rowData = table.row(this).data();
                        if(selectColumnIndex != undefined && rowData != undefined)
                        {
                            var options = {
                            openInNewWindow : true
                            };

                            debugger;
                        // parent.Xrm.Utility.openEntityForm('nav_credit', cellRowData.nav_creditid_key, null, options);
               
                            if(selectColumnIndex === creditColumnId)
                            {
                                openEntityForm("nav_credit", rowData.nav_creditid_key);
                            }
                            else if(selectColumnIndex === modelColumnId)
                            {
                                openEntityForm("nav_model", rowData.nav_modelid_key);
                            }
                        }

                        });
        };
        function openEntityForm(entity_name, entityId){
            var entityFormOptions = {};
                        entityFormOptions["entityName"] = entity_name;
                        entityFormOptions["entityId"] = entityId;
                        //entityFormOptions["openInNewWindow"] = "true";

                        Xrm.Navigation.openForm(entityFormOptions).then(
                        function (success) {
                            console.log(success);
                        },
                        function (error) {
                            console.log(error);
                        });
        };
        </script>
    </head>
    <body>
        <table id="CreditInfoTable" class="cell-border">
            <thead>
                <tr>
                    <td>Кредитная программа</td>
                    <td>Модель</td>
                    <td>Срок кредита</td>
                </tr>
            </thead>
        </table>
    </body>
</html>